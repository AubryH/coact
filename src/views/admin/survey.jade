extends ../header.jade
block head
  title CoactAdmin - Surveys
block vars
  - var nav = 'surveys'
  - var bgPage = 'bg-grey'
block component
  .jumbotron
    .container
      .row
        .col-md-12
          h2= 'Formations with token : "' + token + '"'
  if newSurvey
    .jumbotron
      .container
        .row
          .col-md-8
            form(novalidate method="post" action="/admin/newSurvey/"+token)
              h3 Ce questionnaire n'existe pas.
              input.btn.btn-primary(type='submit' value='Créer ce questionnaire')
  else
    script(type='text/javascript').
      var pages = [];
    .survey(ng-controller='adminSurveyFormCtrl')
      for page, indexP in formation.pages
        - var pagePath = 'pages[' + indexP + ']'
        script(type='text/javascript').
          !{pagePath} = {questions: []};

        for question, indexQ in page.questions
          - var questionPath = pagePath + '.questions[' + indexQ + ']'

          script(type='text/javascript').
            !{questionPath} = {
              label: !{JSON.stringify(question.label)},
              mark: !{JSON.stringify(question.mark)},
              comment: !{JSON.stringify(question.comment)}
            };

      form(
        novalidate
        method="post"
        action="/admin/updateSurvey/"+ token
        )
        .survey-page(ng-repeat="page in pages" ng-show="$index == currentPage")
          .jumbotron
            .container
              .row
                .col-md-8
                  h3= 'PAGE {{$index + 1}}'
                  .page-content

                    .question(ng-repeat="question in page.questions")
                      h4
                        span= 'Question {{$index + 1}}'
                        span.close(ng-click="removeQuestion(page, question)") x
                        .container
                          .col-md-11.col-md-offset-1
                          .question-label
                            h5 Intitulé : &nbsp;
                            input(
                              type='textbox'
                              name="pages[{{$parent.$index}}].questions[{{$index}}]['label']"
                              placeholder='Tapez votre question'
                              value="question.label"
                              ng-model= 'question.label'
                              )
                          .question-mark
                            h5 Question notée&nbsp;?&nbsp;
                              input(
                                type="checkbox"
                                name="pages[{{$parent.$index}}].questions[{{$index}}]['allow-mark']"
                                ng-model= 'question.mark.allow'
                              )
                            input(
                              type="hidden"
                              name="pages[{{$parent.$index}}].questions[{{$index}}]['mark']"
                              ng-model= 'question.mark.value'
                              value= '{{question.mark.value}}'
                            )
                            .response(
                              ng-show= 'question.mark.allow'
                            ) Note : {{getMark(question)}}
                          .question-comment
                            h5 Question ouverte&nbsp;?&nbsp;
                              input(
                                type="checkbox"
                                name="pages[{{$parent.$index}}].questions[{{$index}}]['allow-comment']"
                                ng-model= 'question.comment.allow'
                              )
                            input(
                              type="hidden"
                              name="pages[{{$parent.$index}}].questions[{{$index}}]['comment']"
                              ng-model= 'question.comment.text'
                              value= '{{question.comment.text}}'
                            )
                            .response(
                              ng-show= 'question.comment.allow'
                            ) Réponse : {{question.comment.text}}
                    .btn.btn-primary(ng-click="addQuestion(page)") Ajoutez une question
        .container.page-handler
          .row
            .col-md-8
              .page-index(
                ng-repeat="page in pages"
                ng-class="$index == currentPage ? 'current' : ''"
                ng-click="setPage($index)"
              ) {{$index + 1}}
              .page-index.add-page(ng-click="addPage()") Ajoutez une page
              input.btn.btn-primary(type='submit' value='Valider le questionnaire')

